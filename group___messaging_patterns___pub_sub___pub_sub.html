<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>UMPS: Publisher-Subscriber</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">UMPS
   </div>
   <div id="projectbrief">The University of Utah Seismograph Stations Message Passing System.</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('group___messaging_patterns___pub_sub___pub_sub.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a>  </div>
  <div class="headertitle">
<div class="title">Publisher-Subscriber<div class="ingroups"><a class="el" href="group___messaging_patterns__chapter.html">Messaging Patterns</a> &raquo; <a class="el" href="group___messaging_patterns___pub_sub.html">Publisher-Subscriber Patterns</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>The publisher-subscriber pattern is the simplest communication mechanism. It is included for pedagogical purposes only. Here, multiple consumers receive messages from one producer.  
<a href="#details">More...</a></p>
<div class="dynheader">
Collaboration diagram for Publisher-Subscriber:</div>
<div class="dyncontent">
<div class="center"><img src="group___messaging_patterns___pub_sub___pub_sub.png" border="0" usemap="#agroup______messaging__patterns______pub__sub______pub__sub" alt=""/></div>
<map name="agroup______messaging__patterns______pub__sub______pub__sub" id="agroup______messaging__patterns______pub__sub______pub__sub">
<area shape="rect" title="The publisher&#45;subscriber pattern is the simplest communication mechanism. It is included for pedagogi..." alt="" coords="208,13,363,38"/>
<area shape="rect" href="group___messaging_patterns___pub_sub.html" title=" " alt="" coords="5,5,160,45"/>
</map>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_u_m_p_s_1_1_messaging_1_1_publisher_subscriber_1_1_publisher.html">UMPS::Messaging::PublisherSubscriber::Publisher</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">A ZeroMQ publisher.  <a href="class_u_m_p_s_1_1_messaging_1_1_publisher_subscriber_1_1_publisher.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_u_m_p_s_1_1_messaging_1_1_publisher_subscriber_1_1_publisher_options.html">UMPS::Messaging::PublisherSubscriber::PublisherOptions</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Options for initializing the publisher in the PUB/SUB pattern.  <a href="class_u_m_p_s_1_1_messaging_1_1_publisher_subscriber_1_1_publisher_options.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_u_m_p_s_1_1_messaging_1_1_publisher_subscriber_1_1_subscriber.html">UMPS::Messaging::PublisherSubscriber::Subscriber</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">The subscriber in a publisher/subscriber messaging pattern.  <a href="class_u_m_p_s_1_1_messaging_1_1_publisher_subscriber_1_1_subscriber.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_u_m_p_s_1_1_messaging_1_1_publisher_subscriber_1_1_subscriber_options.html">UMPS::Messaging::PublisherSubscriber::SubscriberOptions</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Options for initializing the subscriber in the PUB/SUB pattern.  <a href="class_u_m_p_s_1_1_messaging_1_1_publisher_subscriber_1_1_subscriber_options.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>The publisher-subscriber pattern is the simplest communication mechanism. It is included for pedagogical purposes only. Here, multiple consumers receive messages from one producer. </p>
<h1><a class="anchor" id="TopicMessagingPatterns_PubSub_Overview"></a>
Pub-Sub Messaging Overview</h1>
<p>This is the most naive messaging strategy available in UMPS. All that happens are that messages are sent from a producer to consumers. This pattern exists for educational and testing purposes and should not be used in production code. </p>
<p><br  />
 </p><div class="image">
<img src="pubsub.jpg" alt="" width="400cm"/>
<div class="caption">
The publisher-subscriber pattern. Here, three subscribers receive messages from one publisher.</div></div>
<p> <br  />
</p>
<p>Despite its simplicity the pub-sub pattern is important. From an application standpoint, it is the mechanism that will allow UMPS to distribute data packets, heartbeat messages, pick messages, earthquake messages, etc. This pattern also will allow me to introduce preliminary concepts like the distinction between <em>connecting</em> and <em>binding</em>.</p>
<h1><a class="anchor" id="TopicMessagingPatterns_PubSub_Example"></a>
An Example</h1>
<p>In this example, a publisher will send a handful of text messages to three subscribers. </p>
<h2><a class="anchor" id="TopicMessagingPatterns_PubSub_ExamplePublisher"></a>
The Publisher</h2>
<p>The important points in this code snippet are that the publisher <em>binds</em> to an endpoint, defines a message to send, then sends the message in a non-blocking way. Notice that the publisher does not care whether or not the subscriber receives the messages. </p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;umps/messaging/publisherSubscriber/publisher.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;umps/messaging/publisherSubscriber/publisherOptions.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;umps/messageFormats/text.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;pubsub.hpp&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span>UMPS::Messaging::PublisherSubscriber;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> publisher()</div>
<div class="line">{</div>
<div class="line">    PublisherOptions publisherOptions;</div>
<div class="line">    publisherOptions.setAddress(<span class="stringliteral">&quot;tcp://127.0.0.1:5555&quot;</span>); <span class="comment">// Bind on this address</span></div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group___applications__u_operator.html#ggae30f32e64f53967cac8d851f01602a67a32c73be0cb175da278c8e2af0811b0d1">Publisher</a> publisher;</div>
<div class="line">    publisher.initialize(publisherOptions);</div>
<div class="line">    <span class="comment">// Wait a bit for the subscriber to connect</span></div>
<div class="line">    std::this_thread::sleep_for(std::chrono::milliseconds(750));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; N_MESSAGES; ++i)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Define a message</span></div>
<div class="line">        <a class="code" href="class_u_m_p_s_1_1_message_formats_1_1_text.html">UMPS::MessageFormats::Text</a> textMessage;</div>
<div class="line">        textMessage.<a class="code" href="class_u_m_p_s_1_1_message_formats_1_1_text.html#af7c8aaccbce613095d7d070b7e2462cb">setContents</a>(<span class="stringliteral">&quot;Message number &quot;</span> + std::to_string(i + 1));</div>
<div class="line">        <span class="comment">// The message is serialized by the Text class and put on the wire</span></div>
<div class="line">        <span class="comment">// by ZeroMQ</span></div>
<div class="line">        publisher.send(textMessage);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="aclass_u_m_p_s_1_1_message_formats_1_1_text_html"><div class="ttname"><a href="class_u_m_p_s_1_1_message_formats_1_1_text.html">UMPS::MessageFormats::Text</a></div><div class="ttdoc">Defines a text-based message. For example, this class would allow you to send the contents of a text ...</div><div class="ttdef"><b>Definition:</b> text.hpp:13</div></div>
<div class="ttc" id="aclass_u_m_p_s_1_1_message_formats_1_1_text_html_af7c8aaccbce613095d7d070b7e2462cb"><div class="ttname"><a href="class_u_m_p_s_1_1_message_formats_1_1_text.html#af7c8aaccbce613095d7d070b7e2462cb">UMPS::MessageFormats::Text::setContents</a></div><div class="ttdeci">void setContents(const std::string &amp;contents) noexcept</div><div class="ttdoc">Sets the contents of a text message.</div></div>
<div class="ttc" id="agroup___applications__u_operator_html_ggae30f32e64f53967cac8d851f01602a67a32c73be0cb175da278c8e2af0811b0d1"><div class="ttname"><a href="group___applications__u_operator.html#ggae30f32e64f53967cac8d851f01602a67a32c73be0cb175da278c8e2af0811b0d1">UMPS::Services::ConnectionInformation::SocketType::Publisher</a></div><div class="ttdeci">@ Publisher</div></div>
</div><!-- fragment --><h2><a class="anchor" id="TopicMessagingPatterns_PubSub_ExampleSubscriber"></a>
The Subscriber</h2>
<p>The important points are that the subscriber <em>connects</em> to an endpoint, receives a pre-agreed upon number of messages, and returns. It is important to consider the blocking (waiting) behavior of the subscriber. If the default is to block indefinitely until a message is received then in this example the program may hang. For this reason, we actually connect the subscriber to the publisher before the publisher is created. You may want to pause for a moment to let that sink in - ZeroMQ allows the subscriber to connect prior to the publisher binding to the socket. <br  />
 </p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;umps/messaging/publisherSubscriber/subscriber.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;umps/messaging/publisherSubscriber/subscriberOptions.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;umps/messageFormats/text.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;umps/messageFormats/messages.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;umps/messageFormats/staticUniquePointerCast.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;pubsub.hpp&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span>UMPS::Messaging::PublisherSubscriber;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> subscriber(<span class="keyword">const</span> <span class="keywordtype">int</span> subscriberID)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Define the message types that the subscriber will receive</span></div>
<div class="line">    <a class="code" href="class_u_m_p_s_1_1_message_formats_1_1_messages.html">UMPS::MessageFormats::Messages</a> messageTypes;</div>
<div class="line">    std::unique_ptr&lt;UMPS::MessageFormats::IMessage&gt; textMessageType</div>
<div class="line">        = std::make_unique&lt;UMPS::MessageFormats::Text&gt; (); </div>
<div class="line">    messageTypes.<a class="code" href="class_u_m_p_s_1_1_message_formats_1_1_messages.html#a6ed03361ef900097e8aa9a7d8b258f4b">add</a>(textMessageType);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Define the subscriber options</span></div>
<div class="line">    SubscriberOptions subscriberOptions;</div>
<div class="line">    subscriberOptions.setAddress(<span class="stringliteral">&quot;tcp://127.0.0.1:5555&quot;</span>); <span class="comment">// Connect to this address</span></div>
<div class="line">    subscriberOptions.setMessageTypes(messageTypes); <span class="comment">// Types of messages to get</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Initialize the subscriber</span></div>
<div class="line">    <a class="code" href="group___applications__u_operator.html#ggae30f32e64f53967cac8d851f01602a67a992c4a5b4628d8ebf671cf460254ee81">Subscriber</a> subscriber;</div>
<div class="line">    subscriber.initialize(subscriberOptions);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Now retrieve messages</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; N_MESSAGES; ++i)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// The message is read off the wire by ZeroMQ and deserialized</span></div>
<div class="line">        <span class="comment">// by the Text class.</span></div>
<div class="line">        <span class="keyword">auto</span> message = subscriber.receive(); <span class="comment">// Blocks until message is received</span></div>
<div class="line">        <span class="comment">// Convert the message so we can look at the contents</span></div>
<div class="line">        <span class="keyword">auto</span> textMessage</div>
<div class="line">            = static_unique_pointer_cast&lt;UMPS::MessageFormats::Text&gt;</div>
<div class="line">              (std::move(message));</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;SubscriberID: &quot;</span> &lt;&lt; subscriberID</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot; received: &quot;</span> &lt;&lt; textMessage-&gt;<a class="code" href="class_u_m_p_s_1_1_message_formats_1_1_text.html#a6d5d6552bd82bc54880175427a6fd260">getContents</a>() &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="aclass_u_m_p_s_1_1_message_formats_1_1_messages_html"><div class="ttname"><a href="class_u_m_p_s_1_1_message_formats_1_1_messages.html">UMPS::MessageFormats::Messages</a></div><div class="ttdoc">This is a container for holding multiple (unique) message formats.</div><div class="ttdef"><b>Definition:</b> messages.hpp:16</div></div>
<div class="ttc" id="aclass_u_m_p_s_1_1_message_formats_1_1_messages_html_a6ed03361ef900097e8aa9a7d8b258f4b"><div class="ttname"><a href="class_u_m_p_s_1_1_message_formats_1_1_messages.html#a6ed03361ef900097e8aa9a7d8b258f4b">UMPS::MessageFormats::Messages::add</a></div><div class="ttdeci">void add(const std::unique_ptr&lt; IMessage &gt; &amp;message)</div><div class="ttdoc">Add the message type to the container.</div></div>
<div class="ttc" id="aclass_u_m_p_s_1_1_message_formats_1_1_text_html_a6d5d6552bd82bc54880175427a6fd260"><div class="ttname"><a href="class_u_m_p_s_1_1_message_formats_1_1_text.html#a6d5d6552bd82bc54880175427a6fd260">UMPS::MessageFormats::Text::getContents</a></div><div class="ttdeci">std::string getContents() const noexcept</div></div>
<div class="ttc" id="agroup___applications__u_operator_html_ggae30f32e64f53967cac8d851f01602a67a992c4a5b4628d8ebf671cf460254ee81"><div class="ttname"><a href="group___applications__u_operator.html#ggae30f32e64f53967cac8d851f01602a67a992c4a5b4628d8ebf671cf460254ee81">UMPS::Services::ConnectionInformation::SocketType::Subscriber</a></div><div class="ttdeci">@ Subscriber</div></div>
</div><!-- fragment --><h2><a class="anchor" id="TopicMessagingPatterns_PubSub_ExampleDriver"></a>
The Driver</h2>
<p>Here is the example driver code that launches this example. We create four threads - a publisher and three subscribers. The subscribers connect first then will block until a message is received. Then the publisher is started. Since this code is brittle, the publisher code pauses after initialization to deal with something called the slow-joiner problem (basically, ZeroMQ has to do some asynchronous work behind the scenes that takes time). In practice, we do not pause since we never send a predefined number of messages in a pub-sub pattern. </p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;pubsub.hpp&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Actually let the subscribers `connect&#39; first</span></div>
<div class="line">    <span class="keyword">auto</span> subscriberThread1 = std::thread(subscriber, 1);</div>
<div class="line">    <span class="keyword">auto</span> subscriberThread2 = std::thread(subscriber, 2);</div>
<div class="line">    <span class="keyword">auto</span> subscriberThread3 = std::thread(subscriber, 3);</div>
<div class="line">    <span class="comment">// Now create the publisher</span></div>
<div class="line">    <span class="keyword">auto</span> publisherThread = std::thread(publisher);</div>
<div class="line">    <span class="comment">// Wait for threads to finish</span></div>
<div class="line">    subscriberThread1.join();</div>
<div class="line">    subscriberThread2.join();</div>
<div class="line">    subscriberThread3.join();</div>
<div class="line">    publisherThread.join();</div>
<div class="line">    <span class="keywordflow">return</span> EXIT_SUCCESS;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="TopicMessagingPatterns_PubSub_Conclusion"></a>
Summary</h2>
<p>The pub-sub is a foundational pattern in messaging that is provides a natural solution for handling streaming data. Additionally, the concepts of binding and connecting were introduced. Despite this, the alert reader is likely asking - what if I have multiple producers? The answer to that question is the <a class="el" href="group___messaging_patterns___pub_sub___x_pub_x_sub.html">Extended Publisher-Subscriber</a> pattern. </p>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Mar 10 2023 21:59:46 for UMPS by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
